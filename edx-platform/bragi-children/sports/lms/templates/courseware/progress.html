<%page expression_filter="h"/>
<%inherit file="/main.html" />
<%namespace name='static' file='/static_content.html'/>
<%def name="online_help_token()"><% return "progress" %></%def>
<%!
from course_modes.models import CourseMode
from lms.djangoapps.certificates.models import CertificateStatuses
from lms.djangoapps.grades.api import constants as grades_constants
from django.utils.translation import ugettext as _
from openedx.core.djangolib.markup import HTML, Text
from django.urls import reverse
from django.conf import settings
from django.utils.http import urlquote_plus
from six import text_type

from openedx.features.enterprise_support.utils import get_enterprise_learner_generic_name
%>

<%
username = get_enterprise_learner_generic_name(request) or student.username
%>

<%block name="bodyclass">view-in-course view-progress</%block>

<%block name="headextra">
<%static:css group='style-course-vendor'/>
<%static:css group='style-course'/>
</%block>


<%namespace name="progress_graph" file="/courseware/progress_graph.js"/>

<%block name="pagetitle">${_("{course_number} Progress").format(course_number=course.display_number_with_default)}</%block>

<%block name="js_extra">
<script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.js')}"></script>
<script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.stack.js')}"></script>
<script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.symbol.js')}"></script>
<script type="text/javascript" src="${static.url('js/courseware/certificates_api.js')}"></script>
<script type="text/javascript" src="${static.url('js/courseware/credit_progress.js')}"></script>
<script>
    ## This JavaScript is being HTML-escaped because it historically has, and it is not clear what
    ## the correct syntax is. For safety, maintain the previous behavior.
    ## xss-lint: disable=mako-invalid-js-filter
    ${progress_graph.body(grade_summary, course.grade_cutoffs, "grade-detail-graph", not course.no_grade, not course.no_grade)}
</script>
</%block>

<%include file="/courseware/course_navigation.html" args="active_page='progress'" />

<main id="main" aria-label="Content" tabindex="-1">
    <div class="container">
        <div class="profile-wrapper">
            <section class="course-info" id="course-info-progress"
              % if getattr(course, 'language'):
                lang="${course.language}"
              % endif
              >
                % if staff_access and studio_url is not None:
                <div class="wrap-instructor-info">
                    <a class="instructor-info-action studio-view" href="${studio_url}">${_("View Grading in studio")}</a>
                </div>
                % endif
                % if course_expiration_fragment:
                    ${HTML(course_expiration_fragment.content)}
                % endif
                <div class="wrapper-msg wrapper-auto-cert">
                    <div id="errors-info" class="errors-info"></div>
                    <%block name="certificate_block">
                        % if not certificate_data:
                        <div class="msg-content">
                                <img src="/static/sports/images/certificate.svg" alt="certificate logo" class="svg-certificate"></img>
                                <h4 class="hd hd-4 title title-cert">No Certificate Yet</h4>
                                <p class="copy msg-cert">
                                Your certificate of completion will show here after you successfully complete the training.
                                </p>
                        </div>
                        % endif
                        %if certificate_data:
                        <div class="auto-cert-message" id="course-success">
                            <div class="has-actions">
                                <% post_url = reverse('generate_user_cert', args=[text_type(course.id)]) %>
                                <div class="msg-actions">
                                    %if certificate_data.cert_web_view_url:
                                    <div class="iframe-container">
                                    <iframe src="${certificate_data.cert_web_view_url}" target="_parent"  target='_top' marginwidth="0" marginheight="0" frameborder="0" scrolling="no" allowfullscreen></iframe>
                                    </div>
                                    %elif certificate_data.cert_status == CertificateStatuses.downloadable and certificate_data.download_url:
                                    <a class="btn" href="${certificate_data.download_url}" rel="noopener" target="_blank">${_("Download Your Certificate")} <span class="sr">${_("Opens in a new browser window")}</span></a>
                                    %elif certificate_data.cert_status == CertificateStatuses.requesting:
                                    <button class="btn generate_certs" data-endpoint="${post_url}" id="btn_generate_cert" style="display:none"></button>
                                    <div class="loading-container">
                                    <?xml version="1.0" encoding="utf-8"?>
                                    <svg class="spin-loader" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="48px" height="48px" xmlns="http://www.w3.org/2000/svg">
                                    <g transform="matrix(1 0 0 1 -512 -223 )">
                                    <path d="M 6.973928495575221 30.752916106194693  C 4.462530690265487 24.425976637168148  5.69837139823009 17.45442265486726  9.805317238938052 12.435920707964605  L 9.765594070088495 15.240813026548675  L 15.412948264778763 15.359984792920358  L 15.627015648849559 2.9157044389380555  L 3.184995117876106 2.7038460318584088  L 3.0680323284955757 8.351200226548674  L 5.815581638230088 8.388717243185841  C 0.12873703646017573 14.991920075044252  -1.6412693352212395 24.36001635823009  1.7218557621238935 32.83830733168142  C 5.402881461238939 42.12053034053098  14.289861425840709 47.95991299539823  23.93817576212389 47.95991299539823  C 25.56683020460177 47.95991299539823  27.217574416991148 47.792188931681416  28.868318629380525 47.45013082194691  L 27.71411402761062 41.919722467964604  C 18.986112611681413 43.738202043185844  10.262065886017698 39.044210680353984  6.974023408141591 30.752807069734516  Z M 46.275640353982304 15.159007433628318  C 41.97225939823009 4.3146817699115045  30.55631150442478 -1.8292120353982306  19.13347115044248 0.5498166371681406  L 20.28547242477876 6.08022499115044  C 29.013473840707967 4.261745415929202  37.737520566371686 8.95573677876106  41.02556304424779 17.242620743362828  C 43.53916417699115 23.574079858407075  42.30112014159292 30.552413309734504  38.18976764601771 35.570350300884954  L 38.225077380530976 32.741164884955744  L 32.57551985840709 32.63523568141592  L 32.38352529557523 45.07725621238938  L 44.82554582654868 45.26925077522123  L 44.93147503008851 39.621896580530965  L 42.20381216283186 39.586586846017696  C 47.87540295929204 32.98790366017698  49.638629861946896 23.631106492035386  46.27544826902655 15.1590300318584  Z " fill-rule="nonzero" fill="#008cc3" stroke="none" transform="matrix(1 0 0 1 512 223 )" />
                                    </g>
                                    </svg>  
                                    <p class="spin-loader-text">Your certificate of completion will show momentarily</p>
                                    </div>
                                    <style>
                                    .spin-loader {
                                    animation-name: spin;
                                    animation-duration: 2000ms;
                                    animation-iteration-count: infinite;
                                    animation-timing-function: linear; 
                                    }

                                    @keyframes spin {
                                    from {
                                    transform: rotate(0deg)
                                    }

                                    to {
                                    transform: rotate(360deg)
                                    }
                                    }
                                    </style>
                                    %endif
                                </div>
                            </div>
                        </div>
                        %endif
                    </%block>
                </div>
                % if credit_course_requirements:
                <section class="credit-eligibility">
                    <h3 class="hd hd-4 eligibility-heading">${_("Requirements for Course Credit")}</h3>
                    <div class="credit-eligibility-container">
                        %if credit_course_requirements['eligibility_status'] == 'not_eligible':
                        <span class="eligibility_msg">${_("{student_name}, you are no longer eligible for credit in this course.").format(student_name=student.profile.name)}</span>
                        %elif credit_course_requirements['eligibility_status'] == 'eligible':
                        <span class="eligibility_msg">
                            ${Text(_("{student_name}, you have met the requirements for credit in this course. {a_start}Go to your dashboard{a_end} to purchase course credit.")).format(
                                student_name=student.profile.name,
                                a_start=HTML("<a href={url}>").format(url=reverse('dashboard')),
                                a_end=HTML("</a>")
                            )}
                        </span>
                        %elif credit_course_requirements['eligibility_status'] == 'partial_eligible':
                        <span>${_("{student_name}, you have not yet met the requirements for credit.").format(student_name=student.profile.name)}</span>
                        %endif

                        <a href="${settings.CREDIT_HELP_LINK_URL}" class="credit-help">
                            <span class="fa fa-question" aria-hidden="true"></span>
                            <span class="sr">${_("Information about course credit requirements")}</span>
                        </a><br />

                        <div class="requirement-container" data-eligible="${credit_course_requirements['eligibility_status']}">
                            %for requirement in credit_course_requirements['requirements']:
                            <div class="requirement">
                                <div class="requirement-name">
                                    ${_(requirement['display_name'])}
                                    %if requirement['namespace'] == 'grade':
                                    <span>${int(requirement['criteria']['min_grade'] * 100)}%</span>
                                    %endif
                                </div>
                                <div class="requirement-status">
                                    %if requirement['status']:
                                        %if requirement['status'] == 'submitted':
                                        <span class="requirement-submitted">${_("Verification Submitted")}</span>
                                        %elif requirement['status'] == 'failed':
                                        <span class="fa fa-times" aria-hidden="true"></span>
                                        <span>${_("Verification Failed" )}</span>
                                        %elif requirement['status'] == 'declined':
                                        <span class="fa fa-times" aria-hidden="true"></span>
                                        <span>${_("Verification Declined" )}</span>
                                        %elif requirement['status'] == 'satisfied':
                                        <span class="fa fa-check" aria-hidden="true"></span>
                                        <span class="localized-datetime" data-datetime="${requirement['status_date']}" data-string="${_('Completed by {date}')}" data-timezone="${user_timezone}" data-language="${user_language}"></span>
                                        %endif
                                    %else:
                                    <span class="not-achieve">${_("Upcoming")}</span>
                                    %endif
                                </div>
                            </div>
                            %endfor
                        </div>
                        <button class="detail-collapse">
                            <span class="fa fa-caret-up" aria-hidden="true"></span>
                            <span class="requirement-detail">${_("Less")}</span>
                        </button>
                    </div>
                </section>
                %endif               
        </div>
    </div>
</main>
<%static:require_module_async module_name="js/dateutil_factory" class_name="DateUtilFactory">
    DateUtilFactory.transform(iterationKey=".localized-datetime");
</%static:require_module_async>
<script>
$(window).load(() => {
    const courseElements = document.querySelector("#btn_generate_cert");
    if (courseElements) {
        courseElements.click()
    }
});  
</script>